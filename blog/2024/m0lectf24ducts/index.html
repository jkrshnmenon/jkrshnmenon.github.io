<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> M0lecon CTF Teaser 2024 ducts Writeup | Jayakrishna Menon Vadayath </title> <meta name="author" content="Jayakrishna Menon Vadayath"> <meta name="description" content="Solving the ducts challenge from M0lecon Teaser 2023"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://jkrshnmenon.github.io/blog/2024/m0lectf24ducts/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="//"> Jayakrishna Menon Vadayath </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">M0lecon CTF Teaser 2024 ducts Writeup</h1> <p class="post-meta"> Created in September 14, 2024 </p> <p class="post-tags"> <a href="//blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="//blog/tag/ctf"> <i class="fa-solid fa-hashtag fa-sm"></i> ctf</a>   <a href="//blog/tag/race-condition"> <i class="fa-solid fa-hashtag fa-sm"></i> race-condition</a>   <a href="//blog/tag/overflow"> <i class="fa-solid fa-hashtag fa-sm"></i> overflow</a>   ·   <a href="//blog/category/writeup"> <i class="fa-solid fa-tag fa-sm"></i> writeup</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>This CTF was the kickoff of Shellphish Academy.</p> <p>Now Shellphish Academy is a lot like DEFCON Academy (which @Zardus explains with such grace in this DEFCON talk). So for this CTF, we had a good number of blue-belt hackers from pwn.college play with Shellphish.</p> <p>It was a fun experience, and I got to meet a bunch of super awesome hackers in the process too.</p> <p>This challenge was pretty fun as well. So lets get into it.</p> <h2 id="step-1-reversing">Step 1: Reversing</h2> <p>The binary forks off a process to act as the <code class="language-plaintext highlighter-rouge">backend</code> process. This <code class="language-plaintext highlighter-rouge">backend</code> process reads input from a pipe and then performs either of two operations based on the type of input.</p> <p>If the input is a message, it is stored into a linked list of messages. Nothing else happens when the <code class="language-plaintext highlighter-rouge">backend</code> receives a message except for writing the content of the message to <code class="language-plaintext highlighter-rouge">/dev/null</code> which is probably not relevant to the solution at all.</p> <p>The other part of <code class="language-plaintext highlighter-rouge">backend</code> is the command handling. And this command handler is the interesting part. There’s three commands that can be sent</p> <ul> <li>Flush messages</li> <li>Print messages</li> <li>Redact message</li> </ul> <p>The first two are pretty self-explanatory. The only extra detail is that <code class="language-plaintext highlighter-rouge">print_messages</code> also prints out some pointers which will be useful for a leak.</p> <p>The <code class="language-plaintext highlighter-rouge">redact_message</code> uses an index specified in the command to walk the linked-list and identify the correct message. It then uses an 8-byte value specified in the command to overwrite the content of the message.</p> <p>This is the structure of the command and message that I identified.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="n">message</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mh">0x40</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">content</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">message</span><span class="p">;</span>

<span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">idx</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">content</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span> <span class="n">command</span><span class="p">;</span></code></pre></figure> <p>The <code class="language-plaintext highlighter-rouge">backend</code> process is only half of the whole binary. The other half is the “frontend” which is a fork-server.</p> <p>The binary spins up a new fork to handle incoming connections to a specific port. This process then uses the <code class="language-plaintext highlighter-rouge">talk</code> function to read messages from the user.</p> <p>These messages are then sent over the pipe to the <code class="language-plaintext highlighter-rouge">backend</code> after which the process exits.</p> <h2 id="step-2-the-bug">Step 2: The Bug</h2> <p>I spent a few minutes trying to see if there was a buffer overflow in the <code class="language-plaintext highlighter-rouge">talk</code> function. Initially it seemed like the input reading loop only terminated on newlines. I soon found that after the buffer limit was reached, the program would go into an infinite loop. No dice.</p> <p>The other alternative was a race-condition since we could spawn multiple threads at the same time. However, the frontend was sending data to the <code class="language-plaintext highlighter-rouge">backend</code> using a <code class="language-plaintext highlighter-rouge">write</code> function call.</p> <p>To the best of my limited kernel knowledge, the <code class="language-plaintext highlighter-rouge">write</code> function is atomic. And after consulting with @kylebot and @zolutal, I was assured that this was the case.</p> <p>But the size of the buffer that the <code class="language-plaintext highlighter-rouge">talk</code> function used was absolutely massive (0x27100)! And after some trial and error, I found that inputs of the size 0x20000 are not written atomically. Which meant that we could cause some mischief.</p> <p>I wrote up a script that created two connections to the port and sent two giant buffers at the same time. And I saw some output that confirmed that the two giant buffers were getting spliced together. Which meant that we could possibly put a fake command into a message content and have the <code class="language-plaintext highlighter-rouge">backend</code> perform our command.</p> <p>The <code class="language-plaintext highlighter-rouge">backend</code> function would read 4 bytes from the pipe and check if the value read was 0 or 1. If the value read was neither, it would just read the next 4 bytes. This meant that even if the message was not split exactly at the fake chunk, it would be fine since the bytes before the fake chunk would simply be read and discarded.</p> <p>I decided to put my fake chunks in the last page of the giant message to give it the highest probability of triggering the race-condition.</p> <h2 id="step-3-the-exploit">Step 3: The Exploit</h2> <p>So with the race-condition, I was able to get a bunch of fake commands executed by the <code class="language-plaintext highlighter-rouge">backend</code>. This gave me PIE leak and a LIBC leak that worked 6/10 times.</p> <p>But for the actual exploit, I confirmed with @x3ero0 that the <code class="language-plaintext highlighter-rouge">redact_message</code> was our target. Recall that with the <code class="language-plaintext highlighter-rouge">redact_message</code> function, we could overwrite 8 bytes of the content of a specific message in the linked-list with a value that we control. Combined with the fact that we can craft arbitrary messages, we basically have memory leaks and an 8-byte arbitrary overwrite.</p> <p>In order to do this, I created a fake message that contained an arbitrary <code class="language-plaintext highlighter-rouge">next</code> pointer. The next question was to identify a target to overwrite and a value to overwrite it with.</p> <p>The binary only had partial RELRO and we could overwrite some of the GOT table pointers. However, the <code class="language-plaintext highlighter-rouge">redact_message</code> would write the value 1 into the message type before overwriting the content. So we had to choose an address <code class="language-plaintext highlighter-rouge">X</code> such that <code class="language-plaintext highlighter-rouge">X-0x50</code> was writable and <code class="language-plaintext highlighter-rouge">X</code> was a GOT function that would be called with controlled input.</p> <p>I found that <code class="language-plaintext highlighter-rouge">fwrite</code> was a good candidate that met these requirements. It was only called when a message was received and only used to write the content of the message into <code class="language-plaintext highlighter-rouge">/dev/null</code>.</p> <p>Eventually I got all my offsets proper and got the shell locally. And since ASU network was interfering with my connection to the challenge server, I had @ElChals run the script and get the flag.</p> <p>The final exploit is available here: <a href="/assets/python/ducts/exploit.py">Exploit</a></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="//blog/2023/m0lectf23noregvm/">M0lecon CTF 2023 NoRegVM Writeup</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="//blog/2023/0ctf22ezvm/">OCTF 2022 EZVM Writeup</a> </li> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2024 Jayakrishna Menon Vadayath. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-LM199MC2FW"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-LM199MC2FW");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> </body> </html>